pipeline {
    agent any

    parameters {
        string(name: 'CHECKOV_DIR', defaultValue: 'helm/events-app', description: 'Directory to scan')
    }

    stages {
        stage('Checkov Scan') {
            agent {
                docker {
                    image 'bridgecrew/checkov:latest'
                    args '--entrypoint=""' // to avoid conflicts with entrypoints
                }
            }
            steps {
                script {
                    if (fileExists(params.CHECKOV_DIR)) {
                        echo "üîç Running checkov on ${params.CHECKOV_DIR}"
                        def result = sh(
                            script: "checkov -d ${params.CHECKOV_DIR} --quiet --compact || true",
                            returnStdout: true
                        ).trim()
                        if (result) {
                            echo "‚ö†Ô∏è Checkov found issues:\n${result}"
                        } else {
                            echo "‚úÖ Checkov passed cleanly for ${params.CHECKOV_DIR}"
                        }
                    } else {
                        echo "‚ùå Checkov skipped: directory '${params.CHECKOV_DIR}' not found"
                    }
                }
            }
        }
    }
}
